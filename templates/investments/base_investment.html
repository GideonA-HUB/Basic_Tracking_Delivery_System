{% extends 'base.html' %}

{% block title %}Investment Portal - Meridian Asset Logistics{% endblock %}

{% block extra_css %}
<style>
    /* Fix layout issues and ensure proper content positioning */
    .investment-content-wrapper {
        margin-top: 0;
        padding-top: 0;
        min-height: calc(100vh - 64px); /* Account for navigation height */
    }
    
    .investment-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    
    .investment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-color: #3b82f6;
    }
    
    .price-change-positive {
        color: #10b981;
    }
    
    .price-change-negative {
        color: #ef4444;
    }
    
    .price-change-neutral {
        color: #6b7280;
    }
    
    .investment-type-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }
    
    .investment-type-hold {
        background-color: #dbeafe;
        color: #1e40af;
    }
    
    .investment-type-delivery {
        background-color: #dcfce7;
        color: #166534;
    }
    
    .portfolio-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .portfolio-card-alt {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .investment-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #3b82f6;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #1f2937;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .dark .investment-card {
        background-color: #1f2937;
        border-color: #374151;
    }
    
    .dark .investment-card:hover {
        border-color: #60a5fa;
    }
    
    .dark .stat-card {
        background-color: #1f2937;
        border-left-color: #60a5fa;
    }
    
    .dark .stat-value {
        color: #f9fafb;
    }
    
    .dark .stat-label {
        color: #d1d5db;
    }
    
    /* Ensure content starts immediately after navigation */
    main {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Fix any potential z-index issues */
    .investment-navigation {
        z-index: 40;
        position: relative;
    }
    
    /* Ensure proper content flow */
    .investment-content {
        position: relative;
        z-index: 1;
    }
    
    /* Remove any default margins/padding that might cause spacing issues */
    .investment-content-wrapper > *:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Ensure navigation doesn't interfere with content */
    .investment-navigation {
        position: relative;
        z-index: 40;
        margin-bottom: 0;
    }
    
    /* Fix any potential body/html spacing issues */
    body, html {
        margin: 0;
        padding: 0;
    }
    
    /* Ensure main content area starts immediately after navigation */
    .investment-content {
        margin-top: 0 !important;
        padding-top: 0 !important;
        position: relative;
        z-index: 1;
    }
    
    /* Hide scroll buttons on investment pages to prevent layout interference */
    .investment-content ~ #scrollToTop,
    .investment-content ~ #scrollToBottom {
        display: none !important;
    }
    
    /* Alternative approach: ensure scroll buttons don't interfere */
    #scrollToTop, #scrollToBottom {
        z-index: 1000;
        pointer-events: auto;
    }
    
    /* Ensure no hidden elements are pushing content down */
    .investment-content-wrapper {
        overflow: visible;
        position: relative;
    }
    
    /* Force content to start at the top */
    .investment-content-wrapper::before {
        content: '';
        display: block;
        height: 0;
        margin: 0;
        padding: 0;
    }
    
    /* Specific fixes for investment pages */
    .investment-content-wrapper h1:first-of-type {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Ensure hero sections start immediately */
    .investment-content-wrapper .text-center:first-of-type {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Remove any top spacing from first elements */
    .investment-content-wrapper > *:first-child {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Investment Navigation -->
    <nav class="investment-navigation bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">
                        Investment Portal
                    </h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <a href="{% url 'investments:investment-marketplace' %}" 
                       class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                        Marketplace
                    </a>
                    
                    {% if user.is_authenticated %}
                        <a href="{% url 'investments:investment-dashboard' %}" 
                           class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                            Dashboard
                        </a>
                        <a href="{% url 'investments:user-portfolio' %}" 
                           class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                            Portfolio
                        </a>
                    {% endif %}
                    
                    {% if user.is_staff %}
                        <a href="{% url 'investments:admin-investment-management' %}" 
                           class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium">
                            Admin
                        </a>
                    {% endif %}
                    
                                         <!-- Mandatory Membership Section -->
                     <div class="relative group">
                         <button class="bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:from-purple-700 hover:to-blue-700 px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center shadow-lg">
                             <i class="fas fa-crown mr-2"></i> Mandatory Membership
                             <i class="fas fa-chevron-down ml-2 text-xs"></i>
                         </button>
                         <div class="absolute right-0 mt-2 w-96 bg-white dark:bg-gray-700 rounded-lg shadow-xl py-4 z-50 hidden group-hover:block border border-gray-200 dark:border-gray-600">
                             <div class="px-4 pb-3 border-b border-gray-200 dark:border-gray-600">
                                 <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">
                                     <i class="fas fa-shield-alt text-purple-500 mr-2"></i>Premium Access Required
                                 </h3>
                                 <p class="text-sm text-gray-600 dark:text-gray-300">
                                     You must be a member to access our updates and resources. Join our exclusive community today!
                                 </p>
                             </div>
                             
                             <div class="px-4 py-3">
                                 <div class="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900 dark:to-blue-900 p-3 rounded-lg border border-green-200 dark:border-green-700">
                                     <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">
                                         <i class="fas fa-wallet text-green-600 mr-2"></i>Payment Details
                                     </h4>
                                     <div class="space-y-3 text-sm">
                                         <div class="flex flex-col space-y-1">
                                             <span class="text-gray-600 dark:text-gray-300 text-xs">Crypto Address:</span>
                                             <div class="flex items-center space-x-2">
                                                 <span class="font-mono text-green-700 dark:text-green-300 text-xs break-all bg-green-100 dark:bg-green-900 px-2 py-1 rounded" id="crypto-address">Hwa9GyJATebQdwiXrab239awyvc572Pe3Vsb2eBWD8wu</span>
                                                 <button onclick="copyCryptoAddress()" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-200" title="Copy address">
                                                     <i class="fas fa-copy text-sm"></i>
                                                 </button>
                                             </div>
                                         </div>
                                         <div class="flex justify-between">
                                             <span class="text-gray-600 dark:text-gray-300">Network:</span>
                                             <span class="font-semibold text-blue-600 dark:text-blue-400">SOL (Solana)</span>
                                         </div>
                                         <div class="flex justify-between">
                                             <span class="text-gray-600 dark:text-gray-300">Token:</span>
                                             <span class="font-semibold text-green-600 dark:text-green-400">USDT</span>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="px-4 pt-3">
                                 <button onclick="copyCryptoAddress()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center justify-center">
                                     <i class="fas fa-copy mr-2"></i> Copy Address
                                 </button>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="investment-content max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        {% block investment_content %}{% endblock %}
    </main>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Fix layout issues - ensure content starts at top
    document.addEventListener('DOMContentLoaded', function() {
        // Force scroll to top on investment pages
        if (window.location.pathname.includes('/investments/')) {
            window.scrollTo(0, 0);
            
            // Also ensure content wrapper starts at top
            const contentWrapper = document.querySelector('.investment-content-wrapper');
            if (contentWrapper) {
                contentWrapper.style.marginTop = '0';
                contentWrapper.style.paddingTop = '0';
            }
        }
    });
    
    // Copy crypto address function
    function copyCryptoAddress() {
        const address = document.getElementById('crypto-address').textContent;
        navigator.clipboard.writeText(address).then(function() {
            // Show success feedback
            const copyButton = event.target.closest('button');
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
            copyButton.classList.add('bg-green-600', 'hover:bg-green-700');
            copyButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            // Reset button after 2 seconds
            setTimeout(function() {
                copyButton.innerHTML = originalText;
                copyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                copyButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);
        }).catch(function(err) {
            console.error('Failed to copy: ', err);
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = address;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            // Show success feedback
            const copyButton = event.target.closest('button');
            const originalText = copyButton.innerHTML;
            copyButton.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
            copyButton.classList.add('bg-green-600', 'hover:bg-green-700');
            copyButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            
            // Reset button after 2 seconds
            setTimeout(function() {
                copyButton.innerHTML = originalText;
                copyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                copyButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);
        });
    }
    
    // Common investment functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(amount);
    }
    
    function formatPercentage(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'percent',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value / 100);
    }
    
    function getPriceChangeClass(change) {
        if (change > 0) return 'price-change-positive';
        if (change < 0) return 'price-change-negative';
        return 'price-change-neutral';
    }
    
    function createPriceChart(canvasId, chartData) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return null;
        
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.labels,
                datasets: [{
                    label: 'Price (USD)',
                    data: chartData.prices,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: {
                            color: 'rgba(156, 163, 175, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(156, 163, 175, 0.1)'
                        }
                    }
                }
            }
        });
    }
    
    // Auto-refresh portfolio data every 30 seconds
    if (window.location.pathname.includes('portfolio') || window.location.pathname.includes('dashboard')) {
        setInterval(function() {
            // Refresh portfolio summary
            fetch('/investments/api/investments/portfolio_summary/')
                .then(response => response.json())
                .then(data => {
                    // Update portfolio display
                    updatePortfolioDisplay(data);
                })
                .catch(error => console.error('Error refreshing portfolio:', error));
        }, 30000);
    }
    
    function updatePortfolioDisplay(portfolioData) {
        // Update portfolio summary cards
        const totalInvested = document.getElementById('total-invested');
        const currentValue = document.getElementById('current-value');
        const totalReturn = document.getElementById('total-return');
        const totalReturnPercentage = document.getElementById('total-return-percentage');
        
        if (totalInvested) totalInvested.textContent = formatCurrency(portfolioData.total_invested);
        if (currentValue) currentValue.textContent = formatCurrency(portfolioData.current_value);
        if (totalReturn) {
            totalReturn.textContent = portfolioData.total_return_display;
            totalReturn.className = portfolioData.is_profitable ? 'text-green-600' : 'text-red-600';
        }
        if (totalReturnPercentage) {
            totalReturnPercentage.textContent = portfolioData.total_return_percentage_display;
            totalReturnPercentage.className = portfolioData.is_profitable ? 'text-green-600' : 'text-red-600';
        }
    }
</script>
{% endblock %}
