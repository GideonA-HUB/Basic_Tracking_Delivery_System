{% extends 'investments/base_investment.html' %}
{% load investment_filters %}

{% block title %}{{ item.name }} - Investment Details{% endblock %}

{% block investment_content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'investments:investment-marketplace' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                    <i class="fas fa-home mr-2"></i>
                    Marketplace
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'investments:investment-marketplace' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                        {{ item.category.name }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500 dark:text-gray-400">{{ item.name }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Item Header -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            {{ item.category.name }}
                        </span>
                        <span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium investment-type-badge investment-type-{{ item.investment_type }}">
                            {{ item.get_investment_type_display }}
                        </span>
                    </div>
                    {% if item.is_featured %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                        <i class="fas fa-star mr-1"></i>
                        Featured
                    </span>
                    {% endif %}
                </div>
                
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{{ item.name }}</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <div class="text-4xl font-bold text-gray-900 dark:text-white mb-2" id="current-price">
                            ${{ item.current_price_usd }}
                        </div>
                        <div class="text-sm {{ item.price_change_24h|get_price_change_class }}" id="price-change">
                            {{ item.price_change_24h|get_price_change_display }}
                            ({{ item.price_change_percentage_24h|get_percentage_change_display }})
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="last-updated">
                            Last updated: {{ item.updated_at|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    
                    {% if item.weight %}
                    <div class="text-right">
                        <div class="text-2xl font-semibold text-gray-900 dark:text-white">{{ item.weight|format_weight }}</div>
                        {% if item.purity %}
                        <div class="text-sm text-gray-600 dark:text-gray-400">{{ item.purity }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <p class="text-gray-600 dark:text-gray-300 text-lg">{{ item.description }}</p>
            </div>

            <!-- Live Price Chart -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Live Price Chart</h3>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">Auto-refresh:</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="livePriceChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        Live Updates Active
                    </div>
                    <div id="chart-status" class="mt-2 text-xs text-gray-500">
                        Chart Status: <span id="chart-update-count">0</span> updates
                    </div>
                </div>
            </div>

            <!-- Investment Details -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Investment Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Investment Range</h4>
                        <p class="text-gray-600 dark:text-gray-300">
                            ${{ item.minimum_investment }} - 
                            {% if item.maximum_investment %}
                                ${{ item.maximum_investment }}
                            {% else %}
                                No limit
                            {% endif %}
                        </p>
                    </div>
                    
                    {% if item.total_available %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Availability</h4>
                        <p class="text-gray-600 dark:text-gray-300">
                            {{ item.currently_available }} of {{ item.total_available }} available
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if item.dimensions %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Dimensions</h4>
                        <p class="text-gray-600 dark:text-gray-300">{{ item.dimensions }}</p>
                    </div>
                    {% endif %}
                    
                    {% if item.origin %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Origin</h4>
                        <p class="text-gray-600 dark:text-gray-300">{{ item.origin }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Take Action</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    {% if item.is_available_for_investment %}
                    <a href="{% url 'investments:invest-in-item' item.id 'hold' %}" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-center">
                        <i class="fas fa-chart-line mr-2"></i>
                        Invest Now
                    </a>
                    {% endif %}
                    
                    {% if item.is_available_for_delivery %}
                    <a href="{% url 'investments:invest-in-item' item.id 'delivery' %}" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-center">
                        <i class="fas fa-shipping-fast mr-2"></i>
                        Buy & Deliver
                    </a>
                    {% endif %}
                    
                    <button id="wishlist-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200" data-item-id="{{ item.id }}">
                        <i class="fas fa-heart mr-2" id="wishlist-icon"></i>
                        <span id="wishlist-text">Add to Watchlist</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Live Price Feed -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Live Price Feed</h3>
                <div id="live-price-feed" class="space-y-3">
                    <!-- Live price updates will be inserted here -->
                </div>
            </div>

            <!-- Similar Items -->
            {% if similar_items %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Similar Investments</h3>
                <div class="space-y-4">
                    {% for similar_item in similar_items %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-blue-300 transition-colors duration-200">
                        <div class="flex items-center space-x-3">
                            {% if similar_item.main_image_url %}
                            <img src="{{ similar_item.main_image_url }}" alt="{{ similar_item.name }}" class="w-16 h-16 object-cover rounded-lg">
                            {% else %}
                            <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                <i class="fas fa-image text-gray-400"></i>
                            </div>
                            {% endif %}
                            
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                    <a href="{% url 'investments:investment-item-detail' similar_item.id %}" class="hover:text-blue-600 dark:hover:text-blue-400">
                                        {{ similar_item.name }}
                                    </a>
                                </h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ similar_item.category.name }}</p>
                                <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ similar_item.current_price_usd }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Related News Widget -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="marketplace-news-widget" data-asset-type="{% if item.category.name == 'Cryptocurrency' %}crypto{% elif item.category.name == 'Real Estate' %}real_estate{% elif item.category.name == 'Stocks' %}stocks{% else %}general{% endif %}">
                    <div class="widget-header">
                        <h3 class="widget-title">
                            <i class="fas fa-newspaper"></i>
                            Related News
                        </h3>
                        <div class="widget-controls">
                            <button class="btn btn-sm btn-outline-primary news-refresh-btn" title="Refresh News">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="widget-content">
                        <div class="news-loading" style="display: none;">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-2 mb-0 text-muted small">Loading related news...</p>
                            </div>
                        </div>
                        
                        <div class="news-list">
                            {% if related_news %}
                                {% for article in related_news %}
                                <div class="news-item {% if article.is_featured %}news-item-featured{% endif %}">
                                    <div class="news-item-content">
                                        <div class="news-item-image">
                                            <img src="{{ article.image_url|default:'/static/images/news-placeholder.svg' }}" 
                                                 alt="{{ article.title }}"
                                                 onerror="this.src='/static/images/news-placeholder.svg'">
                                        </div>
                                        <div class="news-item-text">
                                            <div class="news-item-meta">
                                                <span class="news-item-source">{{ article.source.name }}</span>
                                                <span class="news-item-category">{{ article.category.display_name }}</span>
                                                <span class="news-item-time">{{ article.published_at|timesince }} ago</span>
                                            </div>
                                            <h4 class="news-item-title">
                                                <a href="{{ article.url }}" target="_blank">{{ article.title|truncatewords:12 }}</a>
                                            </h4>
                                            <p class="news-item-summary">{{ article.summary|truncatewords:18 }}</p>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted small">No related news available</p>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="news-error" style="display: none;">
                            <div class="alert alert-warning alert-sm">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Unable to load news</strong>
                                <p class="mb-0 small">Please try refreshing or check your connection.</p>
                            </div>
                        </div>
                        
                        <div class="widget-footer">
                            <a href="{% url 'investments:news-dashboard' %}" class="btn btn-sm btn-link">
                                View All News <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Category</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.category.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Type</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.get_investment_type_display }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Min Investment</span>
                        <span class="font-medium text-gray-900 dark:text-white">${{ item.minimum_investment }}</span>
                    </div>
                    {% if item.weight %}
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Weight</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.weight|format_weight }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Added</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket and Chart Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- News Widget Styles -->
<style>
.marketplace-news-widget {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 20px;
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.widget-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0;
    color: white;
}

.widget-title i {
    margin-right: 8px;
    color: #f39c12;
}

.widget-controls .btn {
    padding: 4px 8px;
    font-size: 0.8rem;
    border-color: rgba(255,255,255,0.3);
    color: white;
}

.widget-controls .btn:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.widget-content {
    padding: 0;
}

.news-list {
    max-height: 400px;
    overflow-y: auto;
}

.news-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.3s ease;
    cursor: pointer;
}

.news-item:last-child {
    border-bottom: none;
}

.news-item:hover {
    background: #f8f9fa;
}

.news-item-content {
    display: flex;
    gap: 12px;
}

.news-item-image {
    flex-shrink: 0;
    width: 80px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
}

.news-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.news-item-text {
    flex: 1;
    min-width: 0;
}

.news-item-meta {
    display: flex;
    gap: 8px;
    margin-bottom: 6px;
    font-size: 0.75rem;
    color: #6c757d;
}

.news-item-source {
    font-weight: 500;
    color: #3498db;
}

.news-item-category {
    background: #e9ecef;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.news-item-time {
    color: #6c757d;
}

.news-item-title {
    font-size: 0.95rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 6px;
    color: #2c3e50;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.news-item-summary {
    font-size: 0.8rem;
    color: #6c757d;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.widget-footer {
    padding: 15px 20px;
    border-top: 1px solid #eee;
    text-align: center;
    background: #f8f9fa;
}

.widget-footer a {
    color: #3498db;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
    transition: color 0.3s ease;
}

.widget-footer a:hover {
    color: #2980b9;
}

/* Dark theme support */
.dark-theme .marketplace-news-widget {
    background: #2c3e50;
}

.dark-theme .news-item:hover {
    background: #34495e;
}

.dark-theme .news-item-title {
    color: #e2e8f0;
}

.dark-theme .news-item-summary {
    color: #a0aec0;
}

.dark-theme .news-item-meta {
    color: #718096;
}

.dark-theme .widget-footer {
    background: #34495e;
    border-top-color: #4a5568;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let priceChart;
    let priceUpdateInterval;
    let ws;
    
    // Initialize live price chart
    function initPriceChart() {
        const ctx = document.getElementById('livePriceChart');
        if (ctx) {
            // Start with current price as initial data point
            const currentPrice = parseFloat('{{ item.current_price_usd }}');
            const now = new Date();
            
            // Create some initial historical data points for better visualization
            const initialLabels = [];
            const initialData = [];
            
            // Generate 5 data points over the last 5 minutes
            for (let i = 4; i >= 0; i--) {
                const time = new Date(now.getTime() - (i * 60000)); // 1 minute intervals
                initialLabels.push(time.toLocaleTimeString());
                
                // Add some realistic price variation (¬±0.5%)
                const variation = (Math.random() - 0.5) * 0.01; // ¬±0.5% variation
                const price = currentPrice * (1 + variation);
                initialData.push(price);
            }
            
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: initialLabels,
                    datasets: [{
                        label: 'Price (USD)',
                        data: initialData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Price: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
    }
    
    // Load historical price data for the chart
    async function loadHistoricalData() {
        try {
            const response = await fetch(`/investments/api/items/{{ item.id }}/price-history/`);
            const data = await response.json();
            
            if (data.success && data.history && data.history.length > 0) {
                console.log('üìä Loading historical data:', data.history.length, 'points');
                
                // Update chart with historical data
                const labels = data.history.map(h => new Date(h.timestamp).toLocaleTimeString());
                const prices = data.history.map(h => parseFloat(h.price));
                
                if (priceChart) {
                    priceChart.data.labels = labels;
                    priceChart.data.datasets[0].data = prices;
                    priceChart.update();
                    console.log('‚úÖ Chart updated with historical data');
                }
            } else {
                console.log('üìä No historical data available, using current price only');
            }
        } catch (error) {
            console.error('‚ùå Error loading historical data:', error);
        }
    }
    
    // Initialize WebSocket connection
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/price-feeds/`;
        
        console.log('üîå Connecting to WebSocket:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket connected successfully');
            updateConnectionStatus(true);
            
            // Subscribe to price updates
            const message = {
                type: 'get_prices'
            };
            console.log('üì§ Sending message:', message);
            ws.send(JSON.stringify(message));
            
            // Also request a force update to ensure we get fresh data
            setTimeout(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    const forceMessage = { type: 'force_update' };
                    console.log('üì§ Sending force update message:', forceMessage);
                    ws.send(JSON.stringify(forceMessage));
                }
            }, 1000);
        };
        
        ws.onmessage = function(event) {
            console.log('üì• Received WebSocket message:', event.data);
            
            try {
                const data = JSON.parse(event.data);
                console.log('üìä Parsed data:', data);
                
                if (data.type === 'price_data' || data.type === 'price_update') {
                    console.log(`üìà Processing ${data.type} with ${data.prices ? data.prices.length : 0} prices`);
                    console.log('üìä Movement stats:', data.movement_stats);
                    console.log('üìä Update count:', data.update_count);
                    
                    updatePriceDisplay(data.prices || []);
                    
                    // Update movement statistics if provided
                    if (data.movement_stats) {
                        updateMovementStatistics(data.movement_stats);
                    }
                } else if (data.type === 'error') {
                    console.error('‚ùå WebSocket error:', data.message);
                    updateConnectionStatus(false, data.message);
                } else {
                    console.log('‚ÑπÔ∏è Unknown message type:', data.type);
                }
            } catch (error) {
                console.error('‚ùå Error parsing WebSocket message:', error);
            }
        };
        
        ws.onclose = function(event) {
            console.log('üîå WebSocket disconnected:', event.code, event.reason);
            updateConnectionStatus(false);
            
            // Reconnect after 5 seconds
            setTimeout(initWebSocket, 5000);
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket error:', error);
            updateConnectionStatus(false, 'Connection error');
        };
    }
    
    // Update connection status display
    function updateConnectionStatus(isConnected, errorMessage = '') {
        const statusEl = document.getElementById('connection-status');
        if (statusEl) {
            if (isConnected) {
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                statusEl.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>Live Updates Active';
            } else {
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                statusEl.innerHTML = `<span class="w-2 h-2 bg-red-400 rounded-full mr-2"></span>${errorMessage || 'Disconnected'}`;
            }
        }
    }
    
    // Update price display
    function updatePriceDisplay(prices) {
        console.log('üîÑ Updating price display with', prices.length, 'prices');
        
        // Update Live Price Feed sidebar
        updateLivePriceFeed(prices);
        
        const currentPriceEl = document.getElementById('current-price');
        const priceChangeEl = document.getElementById('price-change');
        const lastUpdatedEl = document.getElementById('last-updated');
        
        if (!currentPriceEl || !priceChangeEl || !lastUpdatedEl) {
            console.error('‚ùå Required price display elements not found');
            return;
        }
        
        // Find the price for current item - try multiple matching strategies
        const currentItemName = '{{ item.name }}';
        const currentItemSymbol = '{{ item.symbol }}';
        
        console.log('üîç Looking for item:', currentItemName, 'with symbol:', currentItemSymbol);
        
        let itemPrice = null;
        
        // First try exact name match
        itemPrice = prices.find(p => p.name === currentItemName);
        if (itemPrice) {
            console.log('‚úÖ Found exact name match:', itemPrice);
        } else {
            // Try symbol match
            itemPrice = prices.find(p => p.symbol === currentItemSymbol);
            if (itemPrice) {
                console.log('‚úÖ Found symbol match:', itemPrice);
            } else {
                // Try partial name match (e.g., "Bitcoin" matches "Bitcoin (BTC)")
                itemPrice = prices.find(p => currentItemName.includes(p.name.split(' ')[0]) || p.name.includes(currentItemName.split(' ')[0]));
                if (itemPrice) {
                    console.log('‚úÖ Found partial name match:', itemPrice);
                }
            }
        }
        
        if (itemPrice) {
            console.log('üí∞ Updating price for item:', itemPrice.name, 'New price:', itemPrice.current_price);
            
            // Update current price with smooth counting animation
            const newPrice = parseFloat(itemPrice.current_price);
            const oldPriceText = currentPriceEl.textContent.replace(/[$,]/g, '');
            const oldPrice = parseFloat(oldPriceText) || 0;
            
            if (newPrice !== oldPrice) {
                // Animate price change with smooth counting
                animatePriceCounter(currentPriceEl, oldPrice, newPrice);
                console.log('üíµ Price updated:', oldPrice, '‚Üí', newPrice);
            }
            
            // Update price change
            const changeAmount = parseFloat(itemPrice.price_change_24h) || 0;
            const changePercent = parseFloat(itemPrice.price_change_percentage_24h) || 0;
            
            const changeClass = changeAmount >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const changeIcon = changeAmount >= 0 ? '‚ñ≤' : '‚ñº';
            
            priceChangeEl.className = `text-sm ${changeClass}`;
            priceChangeEl.innerHTML = `${changeIcon} $${Math.abs(changeAmount).toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            
            // Update last updated time
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            
            // Update the chart with new price data
            updatePriceChart(itemPrice);
            
            console.log('‚úÖ Price display updated successfully');
        } else {
            console.warn('‚ö†Ô∏è No matching price found for item:', currentItemName);
            console.log('üìä Available prices:', prices.map(p => `${p.name} (${p.symbol}): $${p.current_price}`));
        }
    }
    
    // Update Live Price Feed sidebar
    function updateLivePriceFeed(prices) {
        console.log('üìä Updating Live Price Feed with', prices.length, 'prices');
        
        const livePriceFeedEl = document.getElementById('live-price-feed');
        if (!livePriceFeedEl) {
            console.error('‚ùå Live Price Feed element not found');
            return;
        }
        
        // Show top 8 prices in the sidebar
        const topPrices = prices.slice(0, 8);
        
        livePriceFeedEl.innerHTML = topPrices.map(price => {
            const changeAmount = parseFloat(price.price_change_24h) || 0;
            const changePercent = parseFloat(price.price_change_percentage_24h) || 0;
            const changeClass = changeAmount >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const changeIcon = changeAmount >= 0 ? '‚ñ≤' : '‚ñº';
            
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-200">
                    <div class="flex-1">
                        <div class="font-semibold text-gray-900 dark:text-white text-sm">${price.name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${price.symbol}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-900 dark:text-white text-sm">$${parseFloat(price.current_price).toFixed(2)}</div>
                        <div class="text-xs ${changeClass}">
                            ${changeIcon} ${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        console.log('‚úÖ Live Price Feed updated with', topPrices.length, 'items');
    }
    
    // Update movement statistics
    function updateMovementStatistics(stats) {
        console.log('üìä Updating movement statistics:', stats);
        
        // Create or update movement statistics display
        let statsContainer = document.getElementById('movement-stats');
        if (!statsContainer) {
            // Create movement statistics container if it doesn't exist
            const livePriceFeedEl = document.getElementById('live-price-feed');
            if (livePriceFeedEl && livePriceFeedEl.parentNode) {
                const statsHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Market Statistics</h3>
                        <div id="movement-stats" class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="totalIncreases">0</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Increases</div>
                            </div>
                            <div class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="totalDecreases">0</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">Decreases</div>
                            </div>
                        </div>
                    </div>
                `;
                livePriceFeedEl.parentNode.insertAdjacentHTML('beforebegin', statsHTML);
                statsContainer = document.getElementById('movement-stats');
            }
        }
        
        if (statsContainer) {
            // Animate counters
            animateCounter(document.getElementById('totalIncreases'), stats.increases || 0);
            animateCounter(document.getElementById('totalDecreases'), stats.decreases || 0);
            
            console.log('‚úÖ Movement statistics updated and animated');
        }
    }
    
    // Animate counter function
    function animateCounter(element, targetValue) {
        if (!element) {
            console.warn('‚ö†Ô∏è animateCounter: Element not found');
            return;
        }
        
        const currentValue = parseInt(element.textContent) || 0;
        console.log(`üéØ Animating counter: ${currentValue} ‚Üí ${targetValue}`);
        
        if (currentValue === targetValue) {
            console.log('‚úÖ Counter already at target value');
            return;
        }
        
        const increment = (targetValue - currentValue) / 10;
        let current = currentValue;
        
        const timer = setInterval(() => {
            current += increment;
            if ((increment > 0 && current >= targetValue) || (increment < 0 && current <= targetValue)) {
                current = targetValue;
                clearInterval(timer);
                console.log(`‚úÖ Counter animation complete: ${targetValue}`);
            }
            element.textContent = Math.round(current);
        }, 50);
    }
    
    // Animate price counter with smooth counting like CoinMarketCap
    function animatePriceCounter(element, startPrice, endPrice) {
        if (!element) {
            console.warn('‚ö†Ô∏è animatePriceCounter: Element not found');
            return;
        }
        
        console.log(`üéØ Animating price: $${startPrice} ‚Üí $${endPrice}`);
        
        if (startPrice === endPrice) {
            console.log('‚úÖ Price already at target value');
            return;
        }
        
        // Color animation for price direction
        element.style.transition = 'color 0.3s ease';
        element.style.color = endPrice > startPrice ? '#10b981' : '#ef4444';
        setTimeout(() => {
            element.style.color = '';
        }, 1500);
        
        // Smooth counting animation
        const duration = 2000; // 2 seconds for smooth counting
        const startTime = Date.now();
        const priceDifference = endPrice - startPrice;
        
        function updatePrice() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Easing function for smooth animation
            const easeOutQuart = 1 - Math.pow(1 - progress, 4);
            const currentPrice = startPrice + (priceDifference * easeOutQuart);
            
            // Format price with proper decimal places
            const formattedPrice = currentPrice.toFixed(2);
            element.textContent = '$' + formattedPrice;
            
            if (progress < 1) {
                requestAnimationFrame(updatePrice);
            } else {
                // Ensure final price is exact
                element.textContent = '$' + endPrice.toFixed(2);
                console.log(`‚úÖ Price animation complete: $${endPrice.toFixed(2)}`);
            }
        }
        
        requestAnimationFrame(updatePrice);
    }
    
    // Start continuous price updates for CoinMarketCap-like effect
    function startContinuousPriceUpdates() {
        let lastKnownPrice = null;
        let continuousUpdateInterval = null;
        
        // Function to create small price variations
        function createSmallPriceVariation(basePrice) {
            // Create small random variations (¬±0.01% to ¬±0.05%)
            const variationPercent = (Math.random() - 0.5) * 0.1; // -0.05% to +0.05%
            const variation = basePrice * (variationPercent / 100);
            return basePrice + variation;
        }
        
        // Function to update price with small variations
        function updatePriceWithVariation() {
            const currentPriceEl = document.getElementById('current-price');
            if (!currentPriceEl || !lastKnownPrice) return;
            
            const currentPriceText = currentPriceEl.textContent.replace(/[$,]/g, '');
            const currentPrice = parseFloat(currentPriceText);
            
            // Only update if we have a valid current price
            if (currentPrice && currentPrice > 0) {
                const newPrice = createSmallPriceVariation(currentPrice);
                
                // Smooth transition to new price
                const priceDifference = newPrice - currentPrice;
                if (Math.abs(priceDifference) > 0.01) { // Only update if change is significant
                    const formattedPrice = newPrice.toFixed(2);
                    currentPriceEl.textContent = '$' + formattedPrice;
                    
                    // Subtle color hint for direction
                    if (priceDifference > 0) {
                        currentPriceEl.style.color = '#10b981';
                    } else {
                        currentPriceEl.style.color = '#ef4444';
                    }
                    
                    // Reset color after short time
                    setTimeout(() => {
                        currentPriceEl.style.color = '';
                    }, 200);
                }
            }
        }
        
        // Override the updatePriceDisplay function to capture the last known price
        const originalUpdatePriceDisplay = updatePriceDisplay;
        updatePriceDisplay = function(prices) {
            // Call original function
            originalUpdatePriceDisplay(prices);
            
            // Capture the last known price for continuous updates
            const currentItemName = '{{ item.name }}';
            const currentItemSymbol = '{{ item.symbol }}';
            
            let itemPrice = prices.find(p => p.name === currentItemName) ||
                           prices.find(p => p.symbol === currentItemSymbol) ||
                           prices.find(p => currentItemName.includes(p.name.split(' ')[0]) || p.name.includes(currentItemName.split(' ')[0]));
            
            if (itemPrice) {
                lastKnownPrice = parseFloat(itemPrice.current_price);
                console.log('üìä Captured price for continuous updates:', lastKnownPrice);
            }
        };
        
        // Start continuous updates every 2-5 seconds
        function startContinuousUpdates() {
            if (continuousUpdateInterval) {
                clearInterval(continuousUpdateInterval);
            }
            
            continuousUpdateInterval = setInterval(() => {
                if (lastKnownPrice) {
                    updatePriceWithVariation();
                }
            }, Math.random() * 3000 + 2000); // Random interval between 2-5 seconds
        }
        
        // Start continuous updates after initial load
        setTimeout(startContinuousUpdates, 5000);
        
        console.log('‚úÖ Continuous price updates started (CoinMarketCap-like effect)');
    }
    
    // Update chart with new price
    function updateChart(newPrice) {
        if (priceChart) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Add new data point
            priceChart.data.labels.push(timeLabel);
            priceChart.data.datasets[0].data.push(newPrice);
            
            // Keep only last 50 data points
            if (priceChart.data.labels.length > 50) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
            }
            
            priceChart.update('none');
        }
    }
    
    // Wishlist functionality
    function initWishlist() {
        const wishlistBtn = document.getElementById('wishlist-btn');
        const wishlistIcon = document.getElementById('wishlist-icon');
        const wishlistText = document.getElementById('wishlist-text');
        
        // Check if item is in wishlist (you'll need to implement this)
        const isInWishlist = localStorage.getItem(`wishlist_${itemId}`);
        
        if (isInWishlist) {
            wishlistIcon.className = 'fas fa-heart mr-2 text-red-500';
            wishlistText.textContent = 'Remove from Watchlist';
        }
        
        wishlistBtn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const isInWishlist = localStorage.getItem(`wishlist_${itemId}`);
            
            if (isInWishlist) {
                // Remove from wishlist
                localStorage.removeItem(`wishlist_${itemId}`);
                wishlistIcon.className = 'fas fa-heart mr-2';
                wishlistText.textContent = 'Add to Watchlist';
                this.classList.remove('bg-red-600');
                this.classList.add('bg-gray-600');
            } else {
                // Add to wishlist
                localStorage.setItem(`wishlist_${itemId}`, 'true');
                wishlistIcon.className = 'fas fa-heart mr-2 text-red-500';
                wishlistText.textContent = 'Remove from Watchlist';
                this.classList.remove('bg-gray-600');
                this.classList.add('bg-red-600');
            }
        });
    }
    
    // Auto-refresh toggle
    function initAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        toggle.addEventListener('change', function() {
            if (this.checked) {
                // Enable auto-refresh
                priceUpdateInterval = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({type: 'get_prices'}));
                    }
                }, 30000); // Update every 30 seconds
            } else {
                // Disable auto-refresh
                if (priceUpdateInterval) {
                    clearInterval(priceUpdateInterval);
                }
            }
        });
        
        // Start auto-refresh by default
        if (toggle.checked) {
            priceUpdateInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'get_prices'}));
                }
            }, 30000);
        }
    }
    
    // Initialize everything
    initPriceChart();
    loadHistoricalData(); // Load historical data for the chart
    initWebSocket();
    initWishlist();
    initAutoRefresh();
    startContinuousPriceUpdates();
    
    // Immediate test to verify chart is working
    setTimeout(() => {
        console.log('üß™ Immediate chart test...');
        testChartImmediately();
    }, 2000); // Wait 2 seconds after page load
    
    // Add some test price variations for demonstration
    setTimeout(() => {
        console.log('üß™ Adding test price variations for demonstration...');
        addTestPriceVariations();
    }, 5000); // Wait 5 seconds after page load
    
    // Start continuous price variations to ensure chart is always updating
    setTimeout(() => {
        console.log('üîÑ Starting continuous price variations...');
        startContinuousPriceVariations();
    }, 10000); // Start after 10 seconds
    
    // Force chart updates every 5 seconds to ensure it's always updating
    setTimeout(() => {
        console.log('üîÑ Starting forced chart updates...');
        startForcedChartUpdates();
    }, 20000); // Start after 20 seconds
    
    // Initialize news widget
    initNewsWidget();
    
    
    // News Widget Functionality
    function initNewsWidget() {
        const newsWidget = document.querySelector('.marketplace-news-widget');
        if (!newsWidget) return;
        
        const assetType = newsWidget.dataset.assetType || 'general';
        const refreshBtn = newsWidget.querySelector('.news-refresh-btn');
        const newsList = newsWidget.querySelector('.news-list');
        const loadingEl = newsWidget.querySelector('.news-loading');
        const errorEl = newsWidget.querySelector('.news-error');
        
        let isLoading = false;
        
        // Load news function
        async function loadNews() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            try {
                const params = new URLSearchParams({
                    type: assetType,
                    limit: 6
                });
                
                const response = await fetch(`/investments/api/news/widget/?${params}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    renderNews(data.articles);
                    hideError();
                } else {
                    showError(data.message || 'Failed to load news');
                }
            } catch (error) {
                console.error('Error loading news:', error);
                showError('Network error. Please check your connection.');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }
        
        // Render news articles
        function renderNews(articles) {
            if (!newsList) return;
            
            newsList.innerHTML = '';
            
            articles.forEach(article => {
                const articleElement = createNewsItemElement(article);
                newsList.appendChild(articleElement);
            });
        }
        
        // Create news item element
        function createNewsItemElement(article) {
            const div = document.createElement('div');
            div.className = `news-item ${article.is_featured ? 'news-item-featured' : ''}`;
            
            div.innerHTML = `
                <div class="news-item-content">
                    <div class="news-item-image">
                        <img src="${article.image_url || '/static/images/news-placeholder.svg'}" 
                             alt="${article.title}"
                             onerror="this.src='/static/images/news-placeholder.svg'">
                    </div>
                    <div class="news-item-text">
                        <div class="news-item-meta">
                            <span class="news-item-source">${article.source_name}</span>
                            <span class="news-item-category">${article.category_name}</span>
                            <span class="news-item-time">${article.time_ago}</span>
                        </div>
                        <h4 class="news-item-title">${article.title}</h4>
                        <p class="news-item-summary">${article.summary}</p>
                    </div>
                </div>
            `;
            
            // Add click handler
            div.addEventListener('click', () => {
                trackClick(article.id);
                window.open(article.url, '_blank');
            });
            
            return div;
        }
        
        // Track click
        async function trackClick(articleId) {
            try {
                await fetch(`/investments/api/news/articles/${articleId}/track_click/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                        'Content-Type': 'application/json',
                    },
                });
            } catch (error) {
                console.error('Error tracking click:', error);
            }
        }
        
        // Show/hide loading and error states
        function showLoading() {
            if (loadingEl) loadingEl.style.display = 'block';
        }
        
        function hideLoading() {
            if (loadingEl) loadingEl.style.display = 'none';
        }
        
        function showError(message) {
            if (errorEl) {
                errorEl.querySelector('p').textContent = message;
                errorEl.style.display = 'block';
            }
        }
        
        function hideError() {
            if (errorEl) errorEl.style.display = 'none';
        }
        
        // Get CSRF token
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.content || '';
        }
        
        // Event listeners
        if (refreshBtn) {
            refreshBtn.addEventListener('click', loadNews);
        }
        
        // Load initial news
        loadNews();
        
        // Auto-refresh every 15 minutes
        setInterval(loadNews, 15 * 60 * 1000);
    }
    
    // Add test price variations for demonstration
    function addTestPriceVariations() {
        if (!priceChart) {
            console.log('‚ùå Chart not initialized for test variations');
            return;
        }
        
        console.log('üß™ Adding test price variations...');
        
        const currentPrice = parseFloat('{{ item.current_price_usd }}');
        const variations = [
            { change: 0.02, label: '+2%' },   // +2%
            { change: -0.015, label: '-1.5%' }, // -1.5%
            { change: 0.03, label: '+3%' },   // +3%
            { change: -0.01, label: '-1%' },  // -1%
            { change: 0.025, label: '+2.5%' } // +2.5%
        ];
        
        let index = 0;
        const addVariation = () => {
            if (index < variations.length) {
                const variation = variations[index];
                const newPrice = currentPrice * (1 + variation.change);
                const now = new Date();
                
                // Simulate a price update
                const mockItemPrice = {
                    current_price: newPrice,
                    price_change_24h: currentPrice * variation.change,
                    price_change_percentage_24h: variation.change * 100
                };
                
                console.log(`üß™ Test variation ${index + 1}: ${variation.label} ‚Üí $${newPrice.toFixed(2)}`);
                
                // Update both chart and price display
                updatePriceChart(mockItemPrice);
                
                // Also update the price display elements
                const currentPriceEl = document.getElementById('current-price');
                const priceChangeEl = document.getElementById('price-change');
                const lastUpdatedEl = document.getElementById('last-updated');
                
                if (currentPriceEl) currentPriceEl.textContent = '$' + newPrice.toFixed(2);
                if (priceChangeEl) {
                    const changeClass = variation.change >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    const changeIcon = variation.change >= 0 ? '‚ñ≤' : '‚ñº';
                    priceChangeEl.className = `text-sm ${changeClass}`;
                    priceChangeEl.innerHTML = `${changeIcon} $${Math.abs(currentPrice * variation.change).toFixed(2)} (${variation.change >= 0 ? '+' : ''}${(variation.change * 100).toFixed(2)}%)`;
                }
                if (lastUpdatedEl) lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                
                index++;
                setTimeout(addVariation, 5000); // Add next variation in 5 seconds
            }
        };
        
        addVariation();
    }
    
    // Start continuous price variations to ensure chart is always updating
    function startContinuousPriceVariations() {
        if (!priceChart) {
            console.log('‚ùå Chart not initialized for continuous variations');
            return;
        }
        
        console.log('üîÑ Starting continuous price variations every 3 seconds...');
        
        const currentPrice = parseFloat('{{ item.current_price_usd }}');
        let basePrice = currentPrice;
        
        const addContinuousVariation = () => {
            // Generate more noticeable random variations (¬±0.2% to ¬±1.0%)
            const variation = (Math.random() - 0.5) * 0.02; // ¬±1.0% max variation
            const newPrice = basePrice * (1 + variation);
            
            // Update base price slightly for trending effect
            basePrice = newPrice;
            
            // Simulate a price update
            const mockItemPrice = {
                current_price: newPrice,
                price_change_24h: newPrice - currentPrice,
                price_change_percentage_24h: ((newPrice - currentPrice) / currentPrice) * 100
            };
            
            console.log(`üîÑ Continuous variation: $${newPrice.toFixed(2)} (${variation >= 0 ? '+' : ''}${(variation * 100).toFixed(2)}%)`);
            updatePriceChart(mockItemPrice);
            
            // Also update the price display
            const currentPriceEl = document.getElementById('current-price');
            const priceChangeEl = document.getElementById('price-change');
            const lastUpdatedEl = document.getElementById('last-updated');
            
            if (currentPriceEl) currentPriceEl.textContent = '$' + newPrice.toFixed(2);
            if (priceChangeEl) {
                const changeClass = variation >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                const changeIcon = variation >= 0 ? '‚ñ≤' : '‚ñº';
                priceChangeEl.className = `text-sm ${changeClass}`;
                priceChangeEl.innerHTML = `${changeIcon} $${Math.abs(newPrice - currentPrice).toFixed(2)} (${variation >= 0 ? '+' : ''}${(variation * 100).toFixed(2)}%)`;
            }
            if (lastUpdatedEl) lastUpdatedEl.textContent = 'Last updated: ' + new Date().toLocaleTimeString();
            
            // Schedule next variation
            setTimeout(addContinuousVariation, 2000); // Every 2 seconds
        };
        
        addContinuousVariation();
    }
    
    // Force chart updates every 5 seconds to ensure it's always updating
    function startForcedChartUpdates() {
        if (!priceChart) {
            console.log('‚ùå Chart not initialized for forced updates');
            return;
        }
        
        console.log('üîÑ Starting forced chart updates every 5 seconds...');
        
        const currentPrice = parseFloat('{{ item.current_price_usd }}');
        let updateCount = 0;
        
        const forceUpdate = () => {
            updateCount++;
            
            // Generate a small variation for each forced update
            const variation = (Math.random() - 0.5) * 0.002; // ¬±0.2% variation
            const newPrice = currentPrice * (1 + variation);
            
            // Simulate a price update
            const mockItemPrice = {
                current_price: newPrice,
                price_change_24h: newPrice - currentPrice,
                price_change_percentage_24h: ((newPrice - currentPrice) / currentPrice) * 100
            };
            
            console.log(`üîÑ Forced update #${updateCount}: $${newPrice.toFixed(2)} (${variation >= 0 ? '+' : ''}${(variation * 100).toFixed(2)}%)`);
            updatePriceChart(mockItemPrice);
            
            // Schedule next forced update
            setTimeout(forceUpdate, 5000); // Every 5 seconds
        };
        
        forceUpdate();
    }
    
    // Immediate test to verify chart is working
    function testChartImmediately() {
        if (!priceChart) {
            console.log('‚ùå Chart not initialized for immediate test');
            return;
        }
        
        console.log('üß™ Running immediate chart test...');
        
        const currentPrice = parseFloat('{{ item.current_price_usd }}');
        
        // Test with a significant price change
        const testPrice = currentPrice * 1.01; // +1% increase
        
        const mockItemPrice = {
            current_price: testPrice,
            price_change_24h: testPrice - currentPrice,
            price_change_percentage_24h: 1.0
        };
        
        console.log(`üß™ Immediate test: $${currentPrice} ‚Üí $${testPrice.toFixed(2)} (+1%)`);
        updatePriceChart(mockItemPrice);
        
        // Test with a decrease after 1 second
        setTimeout(() => {
            const testPrice2 = currentPrice * 0.99; // -1% decrease
            const mockItemPrice2 = {
                current_price: testPrice2,
                price_change_24h: testPrice2 - currentPrice,
                price_change_percentage_24h: -1.0
            };
            
            console.log(`üß™ Immediate test: $${testPrice.toFixed(2)} ‚Üí $${testPrice2.toFixed(2)} (-1%)`);
            updatePriceChart(mockItemPrice2);
        }, 1000);
    }
    
    // Update price chart with new data
    function updatePriceChart(itemPrice) {
        if (!priceChart) {
            console.log('‚ùå Price chart not initialized');
            return;
        }
        
        console.log('üìä Updating chart with new price:', itemPrice.current_price);
        
        // Get current chart data
        const chartData = priceChart.data;
        const newPrice = parseFloat(itemPrice.current_price);
        const now = new Date();
        
        // Check if this is a significant price change (avoid adding identical prices)
        const lastPrice = chartData.datasets[0].data.length > 0 ? 
            chartData.datasets[0].data[chartData.datasets[0].data.length - 1] : null;
        
        // Always add new data point to show time progression (even if price is similar)
        // This ensures the chart shows live updates even with small price changes
        console.log('üìà Adding chart data point:', lastPrice, '‚Üí', newPrice);
        
        // Add new data point
        chartData.labels.push(now.toLocaleTimeString());
        chartData.datasets[0].data.push(newPrice);
        
        // Keep only last 15 data points to prevent chart from getting too crowded
        if (chartData.labels.length > 15) {
            chartData.labels.shift();
            chartData.datasets[0].data.shift();
        }
        
        // Update chart with animation
        priceChart.update('active');
        
        console.log('‚úÖ Chart updated with new price data - Labels:', chartData.labels.length, 'Data points:', chartData.datasets[0].data.length);
        console.log('üìä Latest data:', chartData.labels[chartData.labels.length - 1], '‚Üí $' + chartData.datasets[0].data[chartData.datasets[0].data.length - 1]);
        
        // Update chart status counter
        const updateCountEl = document.getElementById('chart-update-count');
        if (updateCountEl) {
            const currentCount = parseInt(updateCountEl.textContent) || 0;
            updateCountEl.textContent = currentCount + 1;
        }
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (ws) {
            ws.close();
        }
        if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
        }
    });
});
</script>
{% endblock %}
