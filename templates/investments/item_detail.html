{% extends 'investments/base_investment.html' %}
{% load investment_filters %}

{% block title %}{{ item.name }} - Investment Details{% endblock %}

{% block investment_content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Breadcrumb -->
    <nav class="flex mb-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'investments:investment-marketplace' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                    <i class="fas fa-home mr-2"></i>
                    Marketplace
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'investments:investment-marketplace' %}" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400">
                        {{ item.category.name }}
                    </a>
                </div>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500 dark:text-gray-400">{{ item.name }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content -->
        <div class="lg:col-span-2">
            <!-- Item Header -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-start justify-between mb-4">
                    <div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                            {{ item.category.name }}
                        </span>
                        <span class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-sm font-medium investment-type-badge investment-type-{{ item.investment_type }}">
                            {{ item.get_investment_type_display }}
                        </span>
                    </div>
                    {% if item.is_featured %}
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                        <i class="fas fa-star mr-1"></i>
                        Featured
                    </span>
                    {% endif %}
                </div>
                
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{{ item.name }}</h1>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <div class="text-4xl font-bold text-gray-900 dark:text-white mb-2" id="current-price">
                            ${{ item.current_price_usd }}
                        </div>
                        <div class="text-sm {{ item.price_change_24h|get_price_change_class }}" id="price-change">
                            {{ item.price_change_24h|get_price_change_display }}
                            ({{ item.price_change_percentage_24h|get_percentage_change_display }})
                        </div>
                        <div class="text-xs text-gray-500 mt-1" id="last-updated">
                            Last updated: {{ item.updated_at|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    
                    {% if item.weight %}
                    <div class="text-right">
                        <div class="text-2xl font-semibold text-gray-900 dark:text-white">{{ item.weight|format_weight }}</div>
                        {% if item.purity %}
                        <div class="text-sm text-gray-600 dark:text-gray-400">{{ item.purity }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <p class="text-gray-600 dark:text-gray-300 text-lg">{{ item.description }}</p>
            </div>

            <!-- Live Price Chart -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Live Price Chart</h3>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-500">Auto-refresh:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="livePriceChart"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        Live Updates Active
                    </div>
                </div>
            </div>

            <!-- Investment Details -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Investment Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Investment Range</h4>
                        <p class="text-gray-600 dark:text-gray-300">
                            ${{ item.minimum_investment }} - 
                            {% if item.maximum_investment %}
                                ${{ item.maximum_investment }}
                            {% else %}
                                No limit
                            {% endif %}
                        </p>
                    </div>
                    
                    {% if item.total_available %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Availability</h4>
                        <p class="text-gray-600 dark:text-gray-300">
                            {{ item.currently_available }} of {{ item.total_available }} available
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if item.dimensions %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Dimensions</h4>
                        <p class="text-gray-600 dark:text-gray-300">{{ item.dimensions }}</p>
                    </div>
                    {% endif %}
                    
                    {% if item.origin %}
                    <div>
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2">Origin</h4>
                        <p class="text-gray-600 dark:text-gray-300">{{ item.origin }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Take Action</h3>
                <div class="flex flex-col sm:flex-row gap-4">
                    {% if item.is_available_for_investment %}
                    <a href="{% url 'investments:invest-in-item' item.id 'hold' %}" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-center">
                        <i class="fas fa-chart-line mr-2"></i>
                        Invest Now
                    </a>
                    {% endif %}
                    
                    {% if item.is_available_for_delivery %}
                    <a href="{% url 'investments:invest-in-item' item.id 'delivery' %}" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200 text-center">
                        <i class="fas fa-shipping-fast mr-2"></i>
                        Buy & Deliver
                    </a>
                    {% endif %}
                    
                    <button id="wishlist-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg transition-colors duration-200" data-item-id="{{ item.id }}">
                        <i class="fas fa-heart mr-2" id="wishlist-icon"></i>
                        <span id="wishlist-text">Add to Watchlist</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <!-- Live Price Feed -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Live Price Feed</h3>
                <div id="live-price-feed" class="space-y-3">
                    <!-- Live price updates will be inserted here -->
                </div>
            </div>

            <!-- Similar Items -->
            {% if similar_items %}
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Similar Investments</h3>
                <div class="space-y-4">
                    {% for similar_item in similar_items %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 hover:border-blue-300 transition-colors duration-200">
                        <div class="flex items-center space-x-3">
                            {% if similar_item.main_image_url %}
                            <img src="{{ similar_item.main_image_url }}" alt="{{ similar_item.name }}" class="w-16 h-16 object-cover rounded-lg">
                            {% else %}
                            <div class="w-16 h-16 bg-gray-200 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                <i class="fas fa-image text-gray-400"></i>
                            </div>
                            {% endif %}
                            
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                    <a href="{% url 'investments:investment-item-detail' similar_item.id %}" class="hover:text-blue-600 dark:hover:text-blue-400">
                                        {{ similar_item.name }}
                                    </a>
                                </h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ similar_item.category.name }}</p>
                                <p class="text-lg font-semibold text-gray-900 dark:text-white">${{ similar_item.current_price_usd }}</p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Quick Stats -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Stats</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Category</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.category.name }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Type</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.get_investment_type_display }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Min Investment</span>
                        <span class="font-medium text-gray-900 dark:text-white">${{ item.minimum_investment }}</span>
                    </div>
                    {% if item.weight %}
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Weight</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.weight|format_weight }}</span>
                    </div>
                    {% endif %}
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Added</span>
                        <span class="font-medium text-gray-900 dark:text-white">{{ item.created_at|date:"M d, Y" }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket and Chart Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let priceChart;
    let priceUpdateInterval;
    let ws;
    
    // Initialize live price chart
    function initPriceChart() {
        const ctx = document.getElementById('livePriceChart');
        if (ctx) {
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: {{ chart_data.labels|safe }},
                    datasets: [{
                        label: 'Price (USD)',
                        data: {{ chart_data.prices|safe }},
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Price: $' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }
    }
    
    // Initialize WebSocket connection
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/price-feeds/`;
        
        console.log('üîå Connecting to WebSocket:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('‚úÖ WebSocket connected successfully');
            updateConnectionStatus(true);
            
            // Subscribe to price updates
            const message = {
                type: 'get_prices'
            };
            console.log('üì§ Sending message:', message);
            ws.send(JSON.stringify(message));
        };
        
        ws.onmessage = function(event) {
            console.log('üì• Received WebSocket message:', event.data);
            
            try {
                const data = JSON.parse(event.data);
                console.log('üìä Parsed data:', data);
                
                if (data.type === 'price_data' || data.type === 'price_update') {
                    console.log(`üìà Processing ${data.type} with ${data.prices ? data.prices.length : 0} prices`);
                    updatePriceDisplay(data.prices || []);
                } else if (data.type === 'error') {
                    console.error('‚ùå WebSocket error:', data.message);
                    updateConnectionStatus(false, data.message);
                } else {
                    console.log('‚ÑπÔ∏è Unknown message type:', data.type);
                }
            } catch (error) {
                console.error('‚ùå Error parsing WebSocket message:', error);
            }
        };
        
        ws.onclose = function(event) {
            console.log('üîå WebSocket disconnected:', event.code, event.reason);
            updateConnectionStatus(false);
            
            // Reconnect after 5 seconds
            setTimeout(initWebSocket, 5000);
        };
        
        ws.onerror = function(error) {
            console.error('‚ùå WebSocket error:', error);
            updateConnectionStatus(false, 'Connection error');
        };
    }
    
    // Update connection status display
    function updateConnectionStatus(isConnected, errorMessage = '') {
        const statusEl = document.getElementById('connection-status');
        if (statusEl) {
            if (isConnected) {
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                statusEl.innerHTML = '<span class="w-2 h-2 bg-green-400 rounded-full mr-2 animate-pulse"></span>Live Updates Active';
            } else {
                statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                statusEl.innerHTML = `<span class="w-2 h-2 bg-red-400 rounded-full mr-2"></span>${errorMessage || 'Disconnected'}`;
            }
        }
    }
    
    // Update price display
    function updatePriceDisplay(prices) {
        console.log('üîÑ Updating price display with', prices.length, 'prices');
        
        const currentPriceEl = document.getElementById('current-price');
        const priceChangeEl = document.getElementById('price-change');
        const lastUpdatedEl = document.getElementById('last-updated');
        
        if (!currentPriceEl || !priceChangeEl || !lastUpdatedEl) {
            console.error('‚ùå Required price display elements not found');
            return;
        }
        
        // Find the price for current item - try multiple matching strategies
        const currentItemName = '{{ item.name }}';
        const currentItemSymbol = '{{ item.symbol }}';
        
        console.log('üîç Looking for item:', currentItemName, 'with symbol:', currentItemSymbol);
        
        let itemPrice = null;
        
        // First try exact name match
        itemPrice = prices.find(p => p.name === currentItemName);
        if (itemPrice) {
            console.log('‚úÖ Found exact name match:', itemPrice);
        } else {
            // Try symbol match
            itemPrice = prices.find(p => p.symbol === currentItemSymbol);
            if (itemPrice) {
                console.log('‚úÖ Found symbol match:', itemPrice);
            } else {
                // Try partial name match (e.g., "Bitcoin" matches "Bitcoin (BTC)")
                itemPrice = prices.find(p => currentItemName.includes(p.name.split(' ')[0]) || p.name.includes(currentItemName.split(' ')[0]));
                if (itemPrice) {
                    console.log('‚úÖ Found partial name match:', itemPrice);
                }
            }
        }
        
        if (itemPrice) {
            console.log('üí∞ Updating price for item:', itemPrice.name, 'New price:', itemPrice.current_price);
            
            // Update current price with animation
            const newPrice = parseFloat(itemPrice.current_price);
            const oldPriceText = currentPriceEl.textContent.replace(/[$,]/g, '');
            const oldPrice = parseFloat(oldPriceText) || 0;
            
            if (newPrice !== oldPrice) {
                // Animate price change
                currentPriceEl.style.transition = 'color 0.3s ease';
                currentPriceEl.style.color = newPrice > oldPrice ? '#10b981' : '#ef4444';
                setTimeout(() => {
                    currentPriceEl.style.color = '';
                }, 1000);
                
                currentPriceEl.textContent = '$' + newPrice.toFixed(2);
                console.log('üíµ Price updated:', oldPrice, '‚Üí', newPrice);
            }
            
            // Update price change
            const changeAmount = parseFloat(itemPrice.price_change_24h) || 0;
            const changePercent = parseFloat(itemPrice.price_change_percentage_24h) || 0;
            
            const changeClass = changeAmount >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
            const changeIcon = changeAmount >= 0 ? '‚ñ≤' : '‚ñº';
            
            priceChangeEl.className = `text-sm ${changeClass}`;
            priceChangeEl.innerHTML = `${changeIcon} $${Math.abs(changeAmount).toFixed(2)} (${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%)`;
            
            // Update last updated time
            const now = new Date();
            lastUpdatedEl.textContent = `Last updated: ${now.toLocaleTimeString()}`;
            
            // Update chart
            updateChart(newPrice);
            
            console.log('‚úÖ Price display updated successfully');
        } else {
            console.warn('‚ö†Ô∏è No matching price found for item:', currentItemName);
            console.log('üìä Available prices:', prices.map(p => `${p.name} (${p.symbol}): $${p.current_price}`));
        }
    }
    
    // Update chart with new price
    function updateChart(newPrice) {
        if (priceChart) {
            const now = new Date();
            const timeLabel = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Add new data point
            priceChart.data.labels.push(timeLabel);
            priceChart.data.datasets[0].data.push(newPrice);
            
            // Keep only last 50 data points
            if (priceChart.data.labels.length > 50) {
                priceChart.data.labels.shift();
                priceChart.data.datasets[0].data.shift();
            }
            
            priceChart.update('none');
        }
    }
    
    // Wishlist functionality
    function initWishlist() {
        const wishlistBtn = document.getElementById('wishlist-btn');
        const wishlistIcon = document.getElementById('wishlist-icon');
        const wishlistText = document.getElementById('wishlist-text');
        
        // Check if item is in wishlist (you'll need to implement this)
        const isInWishlist = localStorage.getItem(`wishlist_${itemId}`);
        
        if (isInWishlist) {
            wishlistIcon.className = 'fas fa-heart mr-2 text-red-500';
            wishlistText.textContent = 'Remove from Watchlist';
        }
        
        wishlistBtn.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const isInWishlist = localStorage.getItem(`wishlist_${itemId}`);
            
            if (isInWishlist) {
                // Remove from wishlist
                localStorage.removeItem(`wishlist_${itemId}`);
                wishlistIcon.className = 'fas fa-heart mr-2';
                wishlistText.textContent = 'Add to Watchlist';
                this.classList.remove('bg-red-600');
                this.classList.add('bg-gray-600');
            } else {
                // Add to wishlist
                localStorage.setItem(`wishlist_${itemId}`, 'true');
                wishlistIcon.className = 'fas fa-heart mr-2 text-red-500';
                wishlistText.textContent = 'Remove from Watchlist';
                this.classList.remove('bg-gray-600');
                this.classList.add('bg-red-600');
            }
        });
    }
    
    // Auto-refresh toggle
    function initAutoRefresh() {
        const toggle = document.getElementById('auto-refresh-toggle');
        
        toggle.addEventListener('change', function() {
            if (this.checked) {
                // Enable auto-refresh
                priceUpdateInterval = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({type: 'get_prices'}));
                    }
                }, 30000); // Update every 30 seconds
            } else {
                // Disable auto-refresh
                if (priceUpdateInterval) {
                    clearInterval(priceUpdateInterval);
                }
            }
        });
        
        // Start auto-refresh by default
        if (toggle.checked) {
            priceUpdateInterval = setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({type: 'get_prices'}));
                }
            }, 30000);
        }
    }
    
    // Initialize everything
    initPriceChart();
    initWebSocket();
    initWishlist();
    initAutoRefresh();
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (ws) {
            ws.close();
        }
        if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
        }
    });
});
</script>
{% endblock %}
