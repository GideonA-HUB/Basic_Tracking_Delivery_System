{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY|default:'YOUR_API_KEY' }}&libraries=geometry"></script>
    <style>
        .location-form {
            background: #fff;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
            max-width: 800px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
        }
        .btn-secondary:hover {
            background: #545b62;
            color: white;
            text-decoration: none;
        }
        .delivery-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .map-preview {
            height: 300px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        .coordinates-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
{% endblock %}

{% block content %}
<div class="delivery-info">
    <h1>{{ title }}</h1>
    <p><strong>Tracking Number:</strong> {{ delivery.tracking_number }}</p>
    <p><strong>Customer:</strong> {{ delivery.customer_name }}</p>
    <p><strong>Current Status:</strong> {{ delivery.get_current_status_display }}</p>
</div>

<div class="location-form">
    <h2>Update Delivery Location</h2>
    
    <form method="post" id="location-form">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="location_name">Location Name:</label>
            <input type="text" id="location_name" name="location_name" class="form-control" 
                   value="{{ delivery.current_location_name|default:'' }}" 
                   placeholder="e.g., Main Street, City Center">
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="latitude">Latitude:</label>
                    <input type="number" id="latitude" name="latitude" step="any" class="form-control" 
                           value="{{ delivery.current_latitude|default:'' }}" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="longitude">Longitude:</label>
                    <input type="number" id="longitude" name="longitude" step="any" class="form-control" 
                           value="{{ delivery.current_longitude|default:'' }}" required>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="accuracy">GPS Accuracy (meters):</label>
            <input type="number" id="accuracy" name="accuracy" step="any" class="form-control" 
                   placeholder="Optional - GPS accuracy in meters">
        </div>
        
        <div class="form-group">
            <button type="button" id="get-current-location" class="btn-secondary">
                üìç Use My Current Location
            </button>
            <button type="button" id="get-address-location" class="btn-secondary">
                üè† Get Coordinates from Address
            </button>
        </div>
        
        <div class="coordinates-display" id="coordinates-display">
            {% if delivery.current_latitude and delivery.current_longitude %}
                Current: {{ delivery.current_latitude }}, {{ delivery.current_longitude }}
            {% else %}
                No current location set
            {% endif %}
        </div>
        
        <div class="map-preview" id="location-preview-map"></div>
        
        <div class="form-group">
            <button type="submit" class="btn-primary">Update Location</button>
            <a href="{% url 'admin:tracking_delivery_change' delivery.pk %}" class="btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
let previewMap = null;
let locationMarker = null;

// Initialize preview map
function initPreviewMap() {
    console.log('üó∫Ô∏è Initializing preview map...');
    
    // Default center
    const defaultCenter = { lat: 40.7128, lng: -74.0060 };
    
    previewMap = new google.maps.Map(document.getElementById('location-preview-map'), {
        zoom: 12,
        center: defaultCenter,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });
    
    // Add existing location if available
    {% if delivery.current_latitude and delivery.current_longitude %}
    const existingPos = new google.maps.LatLng({{ delivery.current_latitude }}, {{ delivery.current_longitude }});
    locationMarker = new google.maps.Marker({
        position: existingPos,
        map: previewMap,
        title: 'Current Location'
    });
    previewMap.setCenter(existingPos);
    {% endif %}
    
    console.log('‚úÖ Preview map initialized');
}

// Update coordinates display
function updateCoordinatesDisplay() {
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    
    if (lat && lng) {
        document.getElementById('coordinates-display').textContent = 
            `Coordinates: ${lat}, ${lng}`;
    } else {
        document.getElementById('coordinates-display').textContent = 'No coordinates set';
    }
}

// Update map marker
function updateMapMarker() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    
    if (isNaN(lat) || isNaN(lng)) return;
    
    const position = new google.maps.LatLng(lat, lng);
    
    // Remove existing marker
    if (locationMarker) {
        locationMarker.setMap(null);
    }
    
    // Add new marker
    locationMarker = new google.maps.Marker({
        position: position,
        map: previewMap,
        title: 'Selected Location'
    });
    
    // Center map on new location
    previewMap.setCenter(position);
}

// Get current location
document.getElementById('get-current-location').addEventListener('click', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitude').value = position.coords.latitude;
            document.getElementById('longitude').value = position.coords.longitude;
            document.getElementById('accuracy').value = position.coords.accuracy;
            
            updateCoordinatesDisplay();
            updateMapMarker();
        }, function(error) {
            alert('Error getting location: ' + error.message);
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
});

// Get coordinates from address
document.getElementById('get-address-location').addEventListener('click', function() {
    const address = prompt('Enter address to get coordinates:');
    if (!address) return;
    
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: address }, function(results, status) {
        if (status === 'OK' && results[0]) {
            const location = results[0].geometry.location;
            document.getElementById('latitude').value = location.lat();
            document.getElementById('longitude').value = location.lng();
            
            updateCoordinatesDisplay();
            updateMapMarker();
        } else {
            alert('Geocoding failed: ' + status);
        }
    });
});

// Update display when coordinates change
document.getElementById('latitude').addEventListener('input', function() {
    updateCoordinatesDisplay();
    updateMapMarker();
});

document.getElementById('longitude').addEventListener('input', function() {
    updateCoordinatesDisplay();
    updateMapMarker();
});

// Form validation
document.getElementById('location-form').addEventListener('submit', function(e) {
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    
    if (!lat || !lng) {
        e.preventDefault();
        alert('Please provide both latitude and longitude');
        return;
    }
    
    if (isNaN(parseFloat(lat)) || isNaN(parseFloat(lng))) {
        e.preventDefault();
        alert('Please provide valid numeric coordinates');
        return;
    }
    
    if (parseFloat(lat) < -90 || parseFloat(lat) > 90) {
        e.preventDefault();
        alert('Latitude must be between -90 and 90');
        return;
    }
    
    if (parseFloat(lng) < -180 || parseFloat(lng) > 180) {
        e.preventDefault();
        alert('Longitude must be between -180 and 180');
        return;
    }
});

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    initPreviewMap();
    updateCoordinatesDisplay();
});
</script>
{% endblock %}
