{% load static %}

<!-- Chat Widget Container -->
<div id="chat-widget" class="fixed bottom-6 right-6 z-50">
    <!-- Chat Toggle Button -->
    <button id="chat-toggle" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition-all duration-300 flex items-center justify-center group">
        <i id="chat-icon" class="fas fa-comments text-xl"></i>
        <span id="chat-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center hidden">0</span>
    </button>
    
    <!-- Chat Window -->
    <div id="chat-window" class="hidden absolute bottom-20 right-0 w-80 h-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-blue-600 text-white p-4 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <i class="fas fa-headset"></i>
                <span class="font-semibold">Live Chat</span>
                <span id="online-indicator" class="w-2 h-2 bg-green-400 rounded-full"></span>
            </div>
            <div class="flex items-center space-x-2">
                <span id="staff-status" class="text-sm">Available</span>
                <button id="chat-minimize" class="text-white hover:text-gray-200">
                    <i class="fas fa-minus"></i>
                </button>
                <button id="chat-close" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Chat Messages Area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- Welcome Message -->
            <div id="welcome-message" class="text-center text-gray-600 dark:text-gray-400 text-sm">
                <i class="fas fa-comments text-2xl mb-2"></i>
                <p>{{ settings.welcome_message|default:"Hello! How can we help you today?" }}</p>
            </div>
            
            <!-- Messages will be loaded here -->
        </div>
        
        <!-- Chat Input Area -->
        <div class="border-t border-gray-200 dark:border-gray-700 p-4">
            <!-- Customer Info Form (for anonymous users) -->
            <div id="customer-info-form" class="mb-4 space-y-2 {% if user.is_authenticated %}hidden{% endif %}">
                <input type="text" id="customer-name" placeholder="Your Name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                <input type="email" id="customer-email" placeholder="Your Email" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                <input type="text" id="customer-phone" placeholder="Your Phone (Optional)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white">
                <input type="text" id="conversation-subject" placeholder="Subject" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white">
            </div>
            
            <!-- Message Input -->
            <div class="flex space-x-2">
                <input type="text" id="message-input" placeholder="Type your message..." class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-sm dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="send-message" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden text-sm text-gray-500 dark:text-gray-400 mt-2">
                <i class="fas fa-circle animate-pulse"></i>
                <span>Staff is typing...</span>
            </div>
        </div>
    </div>
</div>

<!-- Chat Widget Styles -->
<style>
    #chat-widget {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #chat-window {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message {
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message.customer {
        margin-left: auto;
        background: #3b82f6;
        color: white;
        border-radius: 18px 18px 4px 18px;
    }
    
    .message.staff {
        background: #f3f4f6;
        color: #374151;
        border-radius: 18px 18px 18px 4px;
    }
    
    .dark .message.staff {
        background: #4b5563;
        color: #e5e7eb;
    }
    
    .message.system {
        background: #fef3c7;
        color: #92400e;
        border-radius: 8px;
        text-align: center;
        font-style: italic;
    }
    
    .dark .message.system {
        background: #78350f;
        color: #fef3c7;
    }
    
    .message-time {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    #chat-messages::-webkit-scrollbar {
        width: 4px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 2px;
    }
    
    .dark #chat-messages::-webkit-scrollbar-track {
        background: #374151;
    }
    
    .dark #chat-messages::-webkit-scrollbar-thumb {
        background: #6b7280;
    }
</style>

<!-- Chat Widget JavaScript -->
<script>
class ChatWidget {
    constructor() {
        this.isOpen = false;
        this.conversationId = null;
        this.isTyping = false;
        this.typingTimeout = null;
        this.messageCheckInterval = null;
        
        this.initializeElements();
        this.bindEvents();
        this.checkForExistingConversation();
    }
    
    initializeElements() {
        this.toggleBtn = document.getElementById('chat-toggle');
        this.chatWindow = document.getElementById('chat-window');
        this.chatIcon = document.getElementById('chat-icon');
        this.chatBadge = document.getElementById('chat-badge');
        this.messagesContainer = document.getElementById('chat-messages');
        this.messageInput = document.getElementById('message-input');
        this.sendBtn = document.getElementById('send-message');
        this.typingIndicator = document.getElementById('typing-indicator');
        this.customerInfoForm = document.getElementById('customer-info-form');
        this.welcomeMessage = document.getElementById('welcome-message');
        this.onlineIndicator = document.getElementById('online-indicator');
        this.staffStatus = document.getElementById('staff-status');
    }
    
    bindEvents() {
        this.toggleBtn.addEventListener('click', () => this.toggleChat());
        this.sendBtn.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendMessage();
            }
        });
        this.messageInput.addEventListener('input', () => this.handleTyping());
        
        // Close buttons
        document.getElementById('chat-close').addEventListener('click', () => this.closeChat());
        document.getElementById('chat-minimize').addEventListener('click', () => this.minimizeChat());
    }
    
    async checkForExistingConversation() {
        try {
            const response = await fetch('/chat/widget/');
            const data = await response.json();
            
            if (data.conversation) {
                this.conversationId = data.conversation.id;
                this.loadMessages();
                this.startMessagePolling();
            }
            
            this.updateOnlineStatus(data.is_online, data.online_staff_count);
        } catch (error) {
            console.error('Error checking for existing conversation:', error);
        }
    }
    
    updateOnlineStatus(isOnline, staffCount) {
        if (isOnline) {
            this.onlineIndicator.className = 'w-2 h-2 bg-green-400 rounded-full';
            this.staffStatus.textContent = `${staffCount} staff online`;
        } else {
            this.onlineIndicator.className = 'w-2 h-2 bg-red-400 rounded-full';
            this.staffStatus.textContent = 'Offline';
        }
    }
    
    toggleChat() {
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            this.chatWindow.classList.remove('hidden');
            this.chatIcon.className = 'fas fa-times text-xl';
            this.messageInput.focus();
            
            if (this.conversationId) {
                this.loadMessages();
            }
        } else {
            this.chatWindow.classList.add('hidden');
            this.chatIcon.className = 'fas fa-comments text-xl';
        }
    }
    
    closeChat() {
        this.isOpen = false;
        this.chatWindow.classList.add('hidden');
        this.chatIcon.className = 'fas fa-comments text-xl';
    }
    
    minimizeChat() {
        this.closeChat();
    }
    
    async startConversation() {
        const customerName = document.getElementById('customer-name').value;
        const customerEmail = document.getElementById('customer-email').value;
        const customerPhone = document.getElementById('customer-phone').value;
        const subject = document.getElementById('conversation-subject').value;
        
        if (!customerName || !customerEmail) {
            alert('Please provide your name and email to start a conversation.');
            return;
        }
        
        try {
            const response = await fetch('/chat/start-conversation/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    customer_name: customerName,
                    customer_email: customerEmail,
                    customer_phone: customerPhone,
                    subject: subject || 'General Inquiry'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.conversationId = data.conversation_id;
                this.customerInfoForm.classList.add('hidden');
                this.welcomeMessage.classList.add('hidden');
                this.startMessagePolling();
                this.addSystemMessage('Conversation started! A staff member will be with you shortly.');
            } else {
                alert('Error starting conversation: ' + data.error);
            }
        } catch (error) {
            console.error('Error starting conversation:', error);
            alert('Error starting conversation. Please try again.');
        }
    }
    
    async sendMessage() {
        const content = this.messageInput.value.trim();
        
        if (!content) return;
        
        // If no conversation exists and user is not authenticated, start one
        if (!this.conversationId && !{{ user.is_authenticated|yesno:"true,false" }}) {
            await this.startConversation();
            if (!this.conversationId) return;
        }
        
        if (!this.conversationId) {
            alert('Please start a conversation first.');
            return;
        }
        
        try {
            const response = await fetch('/chat/send-message/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': this.getCSRFToken()
                },
                body: JSON.stringify({
                    conversation_id: this.conversationId,
                    content: content,
                    message_type: 'text'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.addMessage(content, 'customer');
                this.messageInput.value = '';
                this.stopTyping();
            } else {
                alert('Error sending message: ' + data.error);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Error sending message. Please try again.');
        }
    }
    
    async loadMessages() {
        if (!this.conversationId) return;
        
        try {
            const response = await fetch(`/chat/messages/${this.conversationId}/`);
            const data = await response.json();
            
            if (data.success) {
                this.messagesContainer.innerHTML = '';
                data.messages.forEach(message => {
                    this.addMessage(message.content, message.is_from_customer ? 'customer' : 'staff', message.created_at);
                });
                this.scrollToBottom();
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }
    
    addMessage(content, sender, timestamp = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender} p-3 mb-2`;
        
        const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        
        messageDiv.innerHTML = `
            <div>${this.escapeHtml(content)}</div>
            <div class="message-time">${time}</div>
        `;
        
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    addSystemMessage(content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system p-3 mb-2 text-sm';
        messageDiv.textContent = content;
        this.messagesContainer.appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    handleTyping() {
        if (!this.isTyping) {
            this.isTyping = true;
            // Send typing indicator to server
        }
        
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => {
            this.stopTyping();
        }, 1000);
    }
    
    stopTyping() {
        this.isTyping = false;
        // Send stop typing indicator to server
    }
    
    startMessagePolling() {
        if (this.messageCheckInterval) {
            clearInterval(this.messageCheckInterval);
        }
        
        this.messageCheckInterval = setInterval(() => {
            this.loadMessages();
        }, 3000); // Check for new messages every 3 seconds
    }
    
    scrollToBottom() {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    }
}

// Initialize chat widget when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new ChatWidget();
});
</script>
